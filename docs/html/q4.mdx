# #4 重绘、回流，如何减少回流？🔥

## 重绘（Repaint）

重绘是指当元素的某些样式发生变化，但不影响布局的情况。浏览器会对更改后的元素重新绘制，如颜色、背景、阴影等的变化。这种操作不会影响到其他元素的位置或大小，因此开销相对较小。

### 重绘触发条件

- 颜色改变（`color`、`background-color`、`border-color` 等）
- 阴影改变（`box-shadow`）

## 回流（Reflow）


回流也称重排，是指当元素的几何属性（如位置、大小等）发生变化时，浏览器需要重新计算布局，重新排列所有元素。

回流的开销比重绘要大得多，因为它可能会引发整个文档的重新布局，尤其在涉及到较多的 DOM 元素时，回流的性能代价会变得非常高。

### 回流触发条件

- 添加或删除可见的 DOM 元素
- 改变元素的尺寸（如 `width`、`height`、`padding`、`margin`）
- 改变元素的位置（`top`、`left`、`bottom`、`right` 等）
- 改变 `display`、`overflow`、`position` 等布局属性
- 调用一些会导致回流的API，比如 `offsetWidth`、`offsetHeight`、`clientWidth`、`clientHeight`、`scrollWidth`、`scrollHeight`、`scrollTop`、`scrollLeft` 等

### 减少回流的优化方法

减少回流的关键在于尽量避免频繁、无必要的布局变化，可以参考以下方法：

1. **合并DOM操作**：避免频繁操作 DOM，可以将多次操作合并为一次，减少回流次数，例如通过 `documentFragment` 一次插入多个节点。（虚拟DOM也是这个原理）。
2. **批量处理样式变更**：减少逐个设置样式的操作，而是用 CSS 类或 `style` 属性一次性更新多个样式。
3. **缓存布局信息**：如果需要频繁获取某些元素的宽高或位置，最好在变量中缓存这些值，避免多次触发回流。
4. **使用`visibility`而不是`display: none`**：`display: none` 会引发回流，因为元素被移除文档流，而 `visibility: hidden` 只会触发重绘。
5. **避免频繁读取和写入布局属性**：如果需要连续读写布局属性，最好将读操作和写操作分开。一次性读取所需的布局信息，然后再进行写操作，这样可以避免多次回流。
6. **使用CSS动画而非JS动画**：CSS 动画通过 GPU 加速，通常只会引起重绘，而不会触发回流。
7. **让元素脱离文档流**：position: absolute / position: fixed / float: left 等属性会让元素脱离文档流，避免频繁回流（只是减少了回流次数，但回流的开销仍然存在）。
8. **使用`translate3d`开启硬件加速**：将元素设置为 `translate3d(0, 0, 0)` 或 `translateZ(0)`，可以开启硬件加速，减少回流，并提高动画性能。

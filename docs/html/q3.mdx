# #3 浏览器渲染原理（概述版） 💪

> 参考
>
> - [图解浏览器渲染原理](https://juejin.cn/post/7262263050102095929)

什么是浏览器渲染？浏览器渲染是指浏览器将 HTML、CSS、JavaScript 转换为可视化页面的过程。

可视化即用户在浏览器中看到的页面，包括文本、图片、视频、动画等内容，所有的一切。

说白了，就是将代码转换为若干个像素点，然后显示在屏幕上。

## 渲染的开始

:::info

浏览器本身就是一个复杂的软件。浏览器的发展从最初的多线程架构，到现在的多进程架构，都是为了提高浏览器的性能和稳定性。

目前，主流浏览器都是多进程架构，包括主进程、渲染进程、GPU 进程、网络进程等。

可以打开 Chrome 浏览器的任务管理器，查看各个进程的运行情况。

![Chrome 浏览器任务管理器](/html/html_q3.png)

- **主进程**：主要负责管理浏览器的界面、用户交互、子进程的管理等。
- **网络进程**：主要负责网络资源的加载，如 HTTP 请求、响应等。
- **渲染进程**：主要负责页面的渲染，每个 Tab 页对应一个渲染进程。(Chrome 浏览器中，每个 Tab 页对应一个渲染进程，但也有例外，如同一站点的多个 Tab 页可能会共享一个渲染进程)。
- **GPU 进程**：主要负责 3D 绘制、动画等。
- 第三方插件进程主要负责插件的运行。

:::

当我们在浏览器地址栏输入一个 URL，按下回车键，浏览器就开始了渲染的过程。

通过`网络进程`发起请求，获取 HTML、CSS、JavaScript 等资源。

`网络进程`不会等到所有资源都下载完成，它会将已经下载的资源生成一个渲染任务交给`渲染进程`，让它开始解析和渲染。
在合适的时机渲染进程进程会从消息队列中取出任务，启动渲染流程。

## 渲染流水线

整个渲染流程分为多个阶段，分别是：

- HTML解析
- 样式计算
- 布局阶段
- 分层
- 图层绘制
- 分块
- 栅格化（光栅化）
- 合成和显示（画面渲染）

每个阶段都有明确的输入输出，上一个阶段的输出会成为下一个阶段的输入。


### HTML和CSS解析

- **HTML 解析**：浏览器从服务器接收到 HTML 文件后，开始逐行解析，将 HTML 标记解析为元素和文本节点，生成 DOM 树。
- **CSS 解析**：同时，浏览器还会解析 CSS 文件，并将其解析为 CSSOM 树（CSS Object Model）。这棵树包含所有样式的计算信息。

### 构建渲染树（Render Tree）

在生成 DOM 树和 CSSOM 树之后，浏览器将二者结合，生成 渲染树。渲染树只包含那些会在页面上显示的节点，不包含非可见节点（如 `<head>`）或使用 display: none 的元素。

渲染树的节点包含每个元素的**内容和计算样式**，这些内容用于后续的布局和绘制。

### 布局（Layout）

布局阶段也称为回流（Reflow），在这个阶段，浏览器根据渲染树，计算每个节点的位置和大小。布局过程会考虑到每个元素的大小、相对或绝对位置、屏幕尺寸等，最终生成一个几何模型。

> 注意：布局阶段完成后，页面上的每个元素都有了确切的坐标和尺寸。

### 绘制（Painting）

布局完成后，浏览器开始绘制（Painting），即将渲染树中的每个节点转换为实际的像素，将内容绘制到屏幕上。这个过程涉及绘制文本、颜色、边框、阴影、图像等。

绘制通常会分多个层次（Layer）进行，以便后续的重绘和优化。

### 复合层（Compositing）

在现代浏览器中，复杂页面会被分割成多个复合层（Composite Layers），每个复合层分别渲染后再组合。这样可以加速某些元素的独立渲染和动画效果，通过 GPU 加速提高渲染效率。

### 层次绘制（Layer Painting）

每个复合层都会被单独绘制，绘制的内容包含文字、图像、边框、阴影等。浏览器会根据 DOM 树和样式树生成绘制列表，然后逐步绘制各层的内容。这一步主要是在 CPU 上执行，将内容转换为位图或图块，并准备好后续处理。

### 栅格化（Rasterization）

栅格化是将层内容从矢量图形（如文字、形状）转换为实际的像素数据。在 GPU 加速的情况下，栅格化过程会通过 GPU 并行执行，以生成多个图块（tiles）。这些图块会被传递给 GPU，供后续的显示组合使用。

### 合成和组合（Compositing）

栅格化后的图块会按层次顺序组合，生成最终的页面显示。复合层的独立处理方式确保每个图块可以独立更新，避免了整个页面重新渲染，提高了显示效率。

### 显示输出

组合完成的页面内容最终传送到显示设备上，呈现给用户。Chrome 会根据显示区域和分辨率调整输出，避免绘制超出视口范围的内容，进一步优化了渲染性能。
